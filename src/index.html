<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>PetCare Assistant</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      rel="stylesheet"
    />
    <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9fafb;
      color: #1f2937;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      padding: 1.5rem 0;
    }
    .container {
      max-width: 1024px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    .header-content {
      display: flex;
      align-items: center;
    }
    .header-content h1 {
      font-size: 1.25rem;
      font-weight: bold;
      color: #1f2937;
      margin-left: 0.5rem;
    }
    .header-content img {
      height: 2rem;
      width: 2rem;
    }
    .main-content {
      padding: 2rem 0;
    }
    .main-content h2 {
      font-size: 2rem;
      font-weight: bold;
      color: #111827;
      text-align: center;
      margin-bottom: 0.75rem;
    }
    .main-content p {
      font-size: 1.125rem;
      color: #6b7280;
      text-align: center;
      max-width: 40rem;
      margin: 0 auto;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
      margin-top: 2rem;
    }

    .btn {
      display: inline-block;
      background-color: #10b981 !important;
      color: #ffffff !important;
      border-radius: 8px !important;
      width: 140px !important;
      height: 20px !important;
      border: none !important;
      padding-top: 5px;
      padding-bottom: 2px;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
    }
    .btn:hover {
      opacity: 0.9;
    }

    @media (min-width: 768px) {
      .grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    .card {
      background-color: #ffffff;
      border: 2px dashed #d1d5db;
      border-radius: 0.5rem;
      padding: 2.5rem;
      text-align: center;
    }
    .card h3 {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .card p {
      font-size: 0.875rem;
      color: #6b7280;
      margin-bottom: 1rem;
    }
    .card button {
      background-color: #10b981;
      color: #ffffff;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
    }
    .card button:disabled {
      background-color: #d1d5db;
      cursor: not-allowed;
    }
    .card svg {
      height: 4rem;
      width: 4rem;
      color: #9ca3af;
      margin-bottom: 1rem;
    }
    .button-group {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
      justify-content: center;
    }
    .button-group button {
      padding: 0.75rem;
      font-size: 1rem;
      border-radius: 0.375rem;
      cursor: pointer;
    }
    .button-group .primary {
      background-color: #10b981;
      color: #ffffff;
      border: none;
      flex: 4;
    }
    .button-group .outline {
      background-color: #ffffff;
      color: #1f2937;
      border: 1px solid #d1d5db;
      flex: 1;
    }
    .how-it-works {
      margin-top: 5rem;
      text-align: center;
    }
    .how-it-works h3 {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
    }
    .how-it-works .grid {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2rem;
      max-width: 48rem;
      margin: 0 auto;
    }

    /* Styling untuk rekomendasi perawatan */
    .pet-care-recommendations {
        background-color: #ffffff;
        border-radius: 8px;
        padding: 1rem; /* Kurangi dari 1.5rem */
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-top: 0.5rem; /* Kurangi dari 1rem */
    }

    .recommendation-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #10b981;
        margin-bottom: 0.5rem; /* Kurangi dari 1rem */
        text-align: center;
        border-bottom: 2px solid #d1fae5;
        padding-bottom: 0.5rem; /* Kurangi dari 0.75rem */
    }

    .special-tips {
        background-color: #f0fdfa;
        border-left: 4px solid #10b981;
        padding: 0.5rem; /* Kurangi dari 0.75rem */
        margin-bottom: 0.75rem; /* Kurangi dari 1.5rem */
        font-style: italic;
        color: #065f46;
    }

    .recommendation-section {
        margin-bottom: 0.75rem; /* Kurangi dari 1.5rem */
        background-color: #f9fafb;
        border-radius: 6px;
        padding: 0.75rem; /* Kurangi dari 1rem */
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
    }

    .section-title i {
      margin-right: 0.5rem;
      color: #10b981;
    }

    .recommendation-item {
      padding: 0.5rem 0;
      line-height: 1.5;
    }

    .recommendation-list {
      list-style-type: none;
      padding-left: 0.5rem;
      margin-top: 0.5rem;
    }

    .recommendation-list li {
        margin-bottom: 0.25rem; /* Kurangi dari 0.5rem */
        display: flex;
        align-items: center;
    }

    .recommendation-list li i {
      margin-right: 0.5rem;
      color: #10b981;
      min-width: 16px;
    }

    .warning-section {
      background-color: #fff3f3;
      border-left: 4px solid #ef4444;
    }

    .warning-section .section-title i {
      color: #ef4444;
    }

    .warning-list li {
      color: #7f1d1d;
    }

    .recommendation-source {
      font-size: 0.8rem;
      color: #6b7280;
      text-align: right;
      margin-top: 1rem;
      font-style: italic;
    }

    .download-section {
        margin-top: 0.75rem; /* Kurangi dari 1.5rem */
        text-align: center;
    }

    .download-btn {
      background-color: #1e40af;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.75rem 1.25rem;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .download-btn:hover {
      background-color: #1e3a8a;
    }

    .download-btn i {
      margin-right: 0.5rem;
    }

    /* PDF Preview styling */
    .pdf-preview {
      border: 1px solid #e5e7eb;
      padding: 1rem;
      margin-top: 1rem;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .pdf-header {
      text-align: center;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 1rem;
    }

    .pdf-header h1 {
      font-size: 1.5rem;
      color: #10b981;
      margin-bottom: 0.5rem;
    }

    .pdf-header p {
      color: #6b7280;
      font-size: 0.9rem;
    }

    .pdf-section {
      margin-bottom: 1rem;
    }

    .pdf-section-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #111827;
    }

    .pdf-loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    @media (min-width: 768px) {
      .how-it-works .grid {
        flex-direction: row;
      }
    }
    .how-it-works .card {
      padding: 1.5rem;
      border: none;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      flex: 1;
      max-width: 15rem;
    }
    .how-it-works .card svg {
      height: 3rem;
      width: 3rem;
      color: #10b981;
      background-color: #d1fae5;
      border-radius: 9999px;
      padding: 0.75rem;
      margin-bottom: 1rem;
    }
    .how-it-works .card h4 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .how-it-works .card p {
      font-size: 0.875rem;
      color: #6b7280;
    }
    footer {
      border-top: 1px solid #e5e7eb;
      padding: 2rem 0;
      text-align: center;
      font-size: 0.875rem;
      color: #6b7280;
    }

    /* Chat-like interface styles */
    .chat-container {
      max-height: 500px;
      overflow-y: auto;
      padding: 1rem;
      text-align: left;
    }

    .chat-message {
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
    }

    .user-message {
      align-items: flex-start;
    }

    .assistant-message {
      align-items: flex-end;
    }

    .message-bubble {
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      max-width: 80%;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .user-bubble {
      background-color: #f3f4f6;
      border-top-left-radius: 0;
    }

    .assistant-bubble {
      background-color: #10b981;
      color: white;
      border-bottom-right-radius: 0;
    }

    .assistant-bubble .pet-care-recommendations {
        color: #333; /* Warna gelap untuk teks di dalam kotak rekomendasi */
        background-color: #ffffff;
        border-radius: 8px;
        padding: 1rem;
    }
    .assistant-bubble .recommendation-title {
        color: #10b981; /* Warna hijau untuk judul rekomendasi */
    }

    .assistant-bubble .section-title {
    color: #111827; /* Warna gelap untuk judul bagian */
    }

    .assistant-bubble .recommendation-item,
    .assistant-bubble p {
        color: #333; /* Warna gelap untuk teks */
    }

    /* Pastikan tombol download memiliki kontras yang baik */
    .assistant-bubble .download-btn {
        background-color: #1e40af;
        color: white;
    }

    .message-time {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-top: 0.25rem;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }

    .loading-dots {
      display: flex;
    }

    .loading-dots span {
      width: 8px;
      height: 8px;
      margin: 0 4px;
      background-color: #10b981;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .loading-dots span:nth-child(1) {
      animation-delay: -0.32s;
    }

    .loading-dots span:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes bounce {
      0%, 80%, 100% {
        transform: scale(0);
      } 40% {
        transform: scale(1.0);
      }
    }

    .section-title {
      font-weight: 600;
      margin-top: 0.5rem;
      margin-bottom: 0.25rem;
    }

    .recommendation-item {
      margin-bottom: 0.5rem;
    }

    .pet-info-section {
      margin-bottom: 1rem;
    }

    .pet-info-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .confidence-badge {
      background-color: #d1fae5;
      color: #047857;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
    }

    .recommendation-source-badge {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
      display: block;
    }

    /* Pre-loader animation */
    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }

    .pulse {
      animation: pulse 1.5s infinite;
    }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="header-content">
          <img alt="" src="src/img/LOGO.png" /> <!-- Replaced with placeholder -->
          <h1>PetCare Assistant</h1>
        </div>
      </div>
    </header>
    <div class="container main-content">
      <div class="text-center">
        <h2>Pet Identification &amp; Care Guide</h2>
        <p>
          Upload a photo of your pet and our AI will identify it and provide
          personalized care recommendations to help you take better care of your
          furry friend.
        </p>
      </div>
      <div class="grid">
        <div class="card" id="uploadImageDropzone">
          <form method="post" id="uploadform" enctype="multipart/form-data">
            <div id="image_preview"></div>
            <div id="icon-image" style="margin: 0px; padding: 0px;">
              <svg
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                ></path>
              </svg>
              <h3>Upload Pet Image</h3>
              <p>Drag and drop an image here or click to browse</p>
            </div>
            <label for="image-upload" class="btn" id="button-submit">Browse Files</label>
            <input
              type="file"
              id="image-upload"
              name="image_upload"
              accept="image/*"
              style="display:none;"
            >
          </form>
        </div>
        <div class="card" id="result-card">
          <div id="initial-content">
            <svg
              fill="none"
              stroke="currentColor"
              viewbox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
              ></path>
            </svg>
            <h3>No Pet Detected Yet</h3>
            <p>
              Upload a photo of your pet and click "Identify Pet" to get started.
            </p>
          </div>
          <div id="chat-container" class="chat-container" style="display: none;">
            <!-- Chat messages will appear here -->
          </div>
        </div>
      </div>
      <div class="button-group">
        <button class="primary" id="identify-button" type="submit" disabled>Identify Pet</button>
        <button class="outline" id="reset-button">Reset</button>
      </div>
      <div class="how-it-works">
        <h3>How it works</h3>
        <div class="grid">
          <div class="card">
            <svg
              fill="none"
              stroke="currentColor"
              viewbox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
              ></path>
            </svg>
            <h4>Upload Photo</h4>
            <p>Take a clear photo of your pet and upload it to our system.</p>
          </div>
          <div class="card">
            <svg
              fill="none"
              stroke="currentColor"
              viewbox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
              ></path>
            </svg>
            <h4>AI Detection</h4>
            <p>
              Our AI analyzes the image to identify the type of pet with high
              accuracy.
            </p>
          </div>
          <div class="card">
            <svg
              fill="none"
              stroke="currentColor"
              viewbox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
              ></path>
            </svg>
            <h4>Get Care Tips</h4>
            <p>
              Receive personalized care recommendations for your specific pet
              type.
            </p>
          </div>
        </div>
      </div>
    </div>
    <footer>
      <p>© 2025 PetCare Assistant. All rights reserved.</p>
      <p>Helping pet owners provide better care through technology.</p>
    </footer>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
          // DOM Elements
          const uploadImageDropzone = document.getElementById('uploadImageDropzone');
          const imageUpload = document.getElementById('image-upload');
          const previewContainer = document.getElementById('image_preview');
          const iconImage = document.getElementById('icon-image');
          const buttonSubmit = document.getElementById('button-submit');
          const identifyButton = document.getElementById('identify-button');
          const resetButton = document.getElementById('reset-button');
          const initialContent = document.getElementById('initial-content');
          const chatContainer = document.getElementById('chat-container');
          const uploadForm = document.getElementById('uploadform');
          let lastPetData = null;

          // Constants
          const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
          const VALID_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/bmp'];

          /**
           * Validates the uploaded image file
           * @param {File} file - The file object to validate
           * @returns {string|null} Error message or null if valid
           */
          function validateImage(file) {
            // Check if file exists
            if (!file) {
              return 'Tidak ada file yang dipilih.';
            }

            // Check file type
            if (!VALID_IMAGE_TYPES.includes(file.type)) {
              return 'File harus berupa gambar (JPG, PNG, GIF, dll).';
            }

            // Check file size
            if (file.size > MAX_FILE_SIZE) {
              return 'Ukuran file terlalu besar. Maksimum 5MB.';
            }

            return null; // No error
          }

          /**
           * Handles image upload and preview
           * @param {HTMLInputElement} input - The file input element
           */
          function handleImageUpload(input) {
            const file = input.files[0];
            const validationError = validateImage(file);

            // Clear previous content
            previewContainer.innerHTML = '';

            if (validationError) {
              // Display error message
              const errorMessage = document.createElement('p');
              errorMessage.className = 'error';
              errorMessage.style.color = '#ef4444';
              errorMessage.textContent = validationError;
              previewContainer.appendChild(errorMessage);

              // Show icon and disable identify button
              iconImage.style.display = 'block';
              identifyButton.disabled = true;
              return;
            }

            // Create and display image preview
            const reader = new FileReader();
            reader.onload = function(e) {
              // Create img element for preview
              const imgPreview = document.createElement('img');
              imgPreview.src = e.target.result;
              imgPreview.style.maxWidth = '100%';
              imgPreview.style.maxHeight = '300px';
              imgPreview.style.marginTop = '20px';
              imgPreview.style.marginBottom = '10px';
              imgPreview.alt = `Preview of ${file.name}`;

              // Add preview to container
              previewContainer.appendChild(imgPreview);

              // Show file name
              const fileNameDisplay = document.createElement('p');
              fileNameDisplay.textContent = `File name: ${file.name}`;
              previewContainer.appendChild(fileNameDisplay);

              // Hide icon and enable identify button
              iconImage.style.display = 'none';
              identifyButton.disabled = false;

              // Show a toast notification
              showToast('Gambar berhasil diunggah!', 'success');
            };

            reader.onerror = function() {
              // Handle file reading errors
              const errorMessage = document.createElement('p');
              errorMessage.className = 'error';
              errorMessage.style.color = '#ef4444';
              errorMessage.textContent = 'Error membaca file. Coba unggah ulang.';
              previewContainer.appendChild(errorMessage);

              iconImage.style.display = 'block';
              identifyButton.disabled = true;
            };

            reader.readAsDataURL(file);
          }

          /**
           * Generate PDF document from pet care recommendations
           * @param {Object} petData - Pet identification and care data
           */
          // Ubah fungsi generatePetCarePDF
            function generatePetCarePDF(petData) {
            showToast('Mempersiapkan PDF...', 'info');

            // Cek apakah library sudah dimuat
            if (window.jspdf && window.html2canvas) {
                createPDF(petData);
                return;
            }

            // Tambahkan jsPDF library
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
            document.head.appendChild(script);

            // Tambahkan html2canvas library
            const script2 = document.createElement('script');
            script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            document.head.appendChild(script2);

            // Pastikan kedua library sudah dimuat sebelum membuat PDF
            let librariesLoaded = 0;

            function checkLibraries() {
                librariesLoaded++;
                if (librariesLoaded === 2 && window.jspdf && window.html2canvas) {
                createPDF(petData);
                }
            }

            script.onload = checkLibraries;
            script2.onload = checkLibraries;

            // Timeout jika library gagal dimuat
            setTimeout(() => {
                if (librariesLoaded < 2) {
                showToast('Gagal memuat library PDF. Coba lagi.', 'error');
                }
            }, 5000);
            }

          /**
           * Create and download the PDF document
           * @param {Object} petData - Pet identification and care data
           */
          function createPDF(petData) {
            // Show loading indicator
            showToast('Menyiapkan dokumen PDF...', 'info');

            try {

            // Pastikan jsPDF sudah dimuat
                if (!window.jspdf) {
                    showToast('Library PDF belum dimuat. Coba lagi.', 'error');
                    return;
                }
              // Create PDF instance
              const { jsPDF } = window.jspdf;
              const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4',
              });

              // Parse data if necessary
              let careData;
              if (typeof petData.care_recommendations === 'string') {
                careData = JSON.parse(petData.care_recommendations);
              } else {
                careData = petData.care_recommendations;
              }

              // Add header
              doc.setFillColor(16, 185, 129); // #10b981
              doc.rect(0, 0, 210, 30, 'F');
              doc.setTextColor(255, 255, 255);
              doc.setFontSize(24);
              doc.text('PetCare Assistant', 105, 15, { align: 'center' });
              doc.setFontSize(12);
              doc.text('Laporan Perawatan Hewan Peliharaan', 105, 22, { align: 'center' });

              // Reset text color to black
              doc.setTextColor(0, 0, 0);

              // Pet identification section
              doc.setFontSize(18);
              doc.text('Identifikasi Hewan', 20, 40);

              doc.setFontSize(12);
              doc.setDrawColor(16, 185, 129); // #10b981
              doc.line(20, 45, 190, 45);

              doc.setFontSize(14);
              doc.text(`Ras: ${petData.predicted_breed}`, 20, 55);
              doc.setFontSize(10);
              doc.text(`Tingkat Keyakinan: ${petData.confidence}%`, 20, 62);
              doc.text(`Model yang digunakan: ${petData.model_used}`, 20, 69);

              // Pet information section
              doc.setFontSize(12);
              doc.text('Informasi:', 20, 80);

              // Format the breed info to fit within page width
              const maxWidth = 170;
              const splitBreedInfo = doc.splitTextToSize(petData.breed_info, maxWidth);
              doc.text(splitBreedInfo, 20, 87);

              // Calculate next Y position after text
              let yPos = 87 + (splitBreedInfo.length * 7);

              // Care recommendations section
              doc.setFontSize(18);
              doc.text('Rekomendasi Perawatan', 20, yPos + 10);

              doc.setFontSize(12);
              doc.setDrawColor(16, 185, 129);
              doc.line(20, yPos + 15, 190, yPos + 15);

              yPos += 25;

              // Add care recommendations
              if (careData && careData.perawatan) {
                // Food section
                if (careData.perawatan.makanan) {
                  doc.setFontSize(14);
                  doc.text('Makanan', 20, yPos);
                  yPos += 7;

                  doc.setFontSize(10);
                  doc.text(`Jenis: ${careData.perawatan.makanan.jenis}`, 25, yPos);
                  yPos += 7;

                  doc.text(`Frekuensi: ${careData.perawatan.makanan.frekuensi}`, 25, yPos);
                  yPos += 15;
                }

                // Health section
                if (careData.perawatan.kesehatan) {
                  // Check if we need a new page
                  if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                  }

                  doc.setFontSize(14);
                  doc.text('Kesehatan', 20, yPos);
                  yPos += 7;

                  if (careData.perawatan.kesehatan.vaksin && careData.perawatan.kesehatan.vaksin.length > 0) {
                    doc.setFontSize(10);
                    doc.text('Vaksin yang direkomendasikan:', 25, yPos);
                    yPos += 7;

                    careData.perawatan.kesehatan.vaksin.forEach(vaksin => {
                      doc.text(`• ${vaksin}`, 30, yPos);
                      yPos += 7;
                    });
                  }

                  if (careData.perawatan.kesehatan.checkup) {
                    doc.setFontSize(10);
                    doc.text(`Checkup: ${careData.perawatan.kesehatan.checkup}`, 25, yPos);
                    yPos += 15;
                  }
                }

                // Grooming section
                if (careData.perawatan.grooming) {
                  // Check if we need a new page
                  if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                  }

                  doc.setFontSize(14);
                  doc.text('Grooming', 20, yPos);
                  yPos += 7;

                  doc.setFontSize(10);
                  doc.text(`Mandi: ${careData.perawatan.grooming.mandi}`, 25, yPos);
                  yPos += 7;

                  doc.text(`Sisir: ${careData.perawatan.grooming.sisir}`, 25, yPos);
                  yPos += 15;
                }

                // Activity section
                if (careData.perawatan.aktivitas) {
                  // Check if we need a new page
                  if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                  }

                  doc.setFontSize(14);
                  doc.text('Aktivitas', 20, yPos);
                  yPos += 7;

                  doc.setFontSize(10);
                  const splitActivity = doc.splitTextToSize(careData.perawatan.aktivitas, maxWidth - 5);
                  doc.text(splitActivity, 25, yPos);
                  yPos += (splitActivity.length * 7) + 8;
                }

                // Warning section
                if (careData.perawatan.peringatan && careData.perawatan.peringatan.length > 0) {
                  // Check if we need a new page
                  if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                  }

                  doc.setFontSize(14);
                  doc.setTextColor(239, 68, 68); // #ef4444 - Red color for warnings
                  doc.text('Peringatan Kesehatan', 20, yPos);
                  yPos += 7;

                  doc.setFontSize(10);
                  careData.perawatan.peringatan.forEach(warning => {
                    const splitWarning = doc.splitTextToSize(`• ${warning}`, maxWidth - 5);
                    doc.text(splitWarning, 25, yPos);
                    yPos += (splitWarning.length * 7) + 3;
                  });

                  // Reset text color to black
                  doc.setTextColor(0, 0, 0);
                  yPos += 8;
                }

                // Tips section
                if (careData.tips_khusus) {
                  // Check if we need a new page
                  if (yPos > 240) {
                    doc.addPage();
                    yPos = 20;
                  }

                  doc.setFontSize(14);
                  doc.text('Tips Khusus', 20, yPos);
                  yPos += 7;

                  doc.setFontSize(10);
                  const splitTips = doc.splitTextToSize(careData.tips_khusus, maxWidth - 5);
                  doc.text(splitTips, 25, yPos);
                  yPos += (splitTips.length * 7) + 15;
                }
              }

              // Add footer with source
              doc.setFontSize(8);
              doc.text(`Sumber: ${careData.sumber || petData.recommendations_source || 'PetCare Assistant'}`, 20, 285);
              doc.text(`Dibuat pada: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 150, 285);

              // Save PDF
              doc.save(`PetCare_${petData.predicted_breed.replace(/\s+/g, '_')}.pdf`);

              showToast('PDF berhasil dibuat dan diunduh!', 'success');
            } catch (err) {
              console.error('Error creating PDF:', err);
              showToast('Gagal membuat PDF: ' + err.message, 'error');
            }
          }

          /**
           * Set up event listener for PDF download button
           * @param {Object} petData - Pet identification and care data
           */
           function setupPDFDownload(petData) {
            const downloadButton = document.getElementById('download-pdf');
            if (downloadButton) {
                downloadButton.addEventListener('click', function() {
                console.log("Download button clicked");
                // Gunakan data yang disimpan jika tersedia
                generatePetCarePDF(petData || lastPetData);
                });
            }
            }

          /**
           * Shows a toast notification
           * @param {string} message - The message to display
           * @param {string} type - The type of toast (success, error, info)
           */
          function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.right = '20px';
            toast.style.padding = '10px 20px';
            toast.style.borderRadius = '4px';
            toast.style.color = '#fff';
            toast.style.zIndex = '9999';
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.3s ease-in';

            // Set background color based on type
            if (type === 'success') {
              toast.style.backgroundColor = '#10b981';
            } else if (type === 'error') {
              toast.style.backgroundColor = '#ef4444';
            } else {
              toast.style.backgroundColor = '#3b82f6';
            }

            // Set message
            toast.textContent = message;

            // Add to body
            document.body.appendChild(toast);

            // Show toast
            setTimeout(() => {
              toast.style.opacity = '1';
            }, 10);

            // Hide toast after 3 seconds
            setTimeout(() => {
              toast.style.opacity = '0';
              setTimeout(() => {
                document.body.removeChild(toast);
              }, 300);
            }, 3000);
          }

          /**
           * Format timestamp for chat messages
           * @returns {string} Formatted time (HH:MM)
           */
          function formatTimestamp() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
          }

          /**
           * Add a message to the chat interface
           * @param {string} content - HTML content of the message
           * @param {boolean} isAssistant - Whether the message is from the assistant
           */
          function addMessage(content, isAssistant = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isAssistant ? 'assistant-message' : 'user-message'}`;
            messageDiv.setAttribute('role', 'listitem');

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `message-bubble ${isAssistant ? 'assistant-bubble' : 'user-bubble'}`;
            bubbleDiv.innerHTML = content;

            const timeSpan = document.createElement('span');
            timeSpan.className = 'message-time';
            timeSpan.textContent = formatTimestamp();

            messageDiv.appendChild(bubbleDiv);
            messageDiv.appendChild(timeSpan);

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }

          /**
           * Show loading indicator in chat
           */
          function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.id = 'loading-indicator';
            loadingDiv.setAttribute('aria-label', 'Loading');

            const dotsDiv = document.createElement('div');
            dotsDiv.className = 'loading-dots';

            for (let i = 0; i < 3; i++) {
              const dot = document.createElement('span');
              dotsDiv.appendChild(dot);
            }

            loadingDiv.appendChild(dotsDiv);
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }

          /**
           * Hide loading indicator
           */
          function hideLoading() {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
              loadingIndicator.remove();
            }
          }

          /**
           * Format care recommendations
           * @param {object|string} recommendations - The recommendations data
           * @returns {string} Formatted HTML content
           */
          function formatCareRecommendations(recommendations) {
            try {
              // Try to parse JSON if it's a string
              const careData = typeof recommendations === 'string' ?
                JSON.parse(recommendations) : recommendations;

              // New format from backend
              if (careData.perawatan) {
                let html = '<div class="pet-care-recommendations">';

                // Add pet breed and any special tips at the top
                if (careData.ras) {
                  html += `<div class="recommendation-title">Rekomendasi Perawatan untuk ${careData.ras}</div>`;
                }

                if (careData.tips_khusus) {
                  html += `<div class="special-tips">${careData.tips_khusus}</div>`;
                }

                // Format food information
                if (careData.perawatan.makanan) {
                  html += '<div class="recommendation-section">';
                  html += '<div class="section-title"><i class="fas fa-drumstick-bite"></i> Makanan</div>';
                  html += `<div class="recommendation-item">
                            <strong>Jenis:</strong> ${careData.perawatan.makanan.jenis}<br>
                            <strong>Frekuensi:</strong> ${careData.perawatan.makanan.frekuensi}
                          </div>`;
                  html += '</div>';
                }

                // Format health information with icons
                if (careData.perawatan.kesehatan) {
                  html += '<div class="recommendation-section">';
                  html += '<div class="section-title"><i class="fas fa-heartbeat"></i> Kesehatan</div>';

                  if (careData.perawatan.kesehatan.vaksin && careData.perawatan.kesehatan.vaksin.length > 0) {
                    html += '<div class="recommendation-item">';
                    html += '<strong>Vaksin yang direkomendasikan:</strong>';
                    html += '<ul class="recommendation-list">';
                    careData.perawatan.kesehatan.vaksin.forEach(vaksin => {
                      html += `<li><i class="fas fa-syringe"></i> ${vaksin}</li>`;
                    });
                    html += '</ul>';
                    html += '</div>';
                  }

                  if (careData.perawatan.kesehatan.checkup) {
                    html += `<div class="recommendation-item">
                              <strong>Checkup:</strong> ${careData.perawatan.kesehatan.checkup}
                            </div>`;
                  }

                  html += '</div>';
                }

                 // Format grooming information
                if (careData.perawatan.grooming) {
                  html += '<div class="recommendation-section">';
                  html += '<div class="section-title"><i class="fas fa-bath"></i> Grooming</div>';
                  html += `<div class="recommendation-item">
                            <strong>Mandi:</strong> ${careData.perawatan.grooming.mandi}<br>
                            <strong>Sisir:</strong> ${careData.perawatan.grooming.sisir}
                          </div>`;
                  html += '</div>';
                }

                // Format activity information
                if (careData.perawatan.aktivitas) {
                  html += '<div class="recommendation-section">';
                  html += '<div class="section-title"><i class="fas fa-running"></i> Aktivitas</div>';
                  html += `<div class="recommendation-item">${careData.perawatan.aktivitas}</div>`;
                  html += '</div>';
                }

                // Format warnings with attention icon
                if (careData.perawatan.peringatan && careData.perawatan.peringatan.length > 0) {
                  html += '<div class="recommendation-section warning-section">';
                  html += '<div class="section-title"><i class="fas fa-exclamation-triangle"></i> Peringatan Kesehatan</div>';
                  html += '<ul class="recommendation-list warning-list">';
                  careData.perawatan.peringatan.forEach(warning => {
                    html += `<li>${warning}</li>`;
                  });
                  html += '</ul>';
                  html += '</div>';
                }

                // Add source information if available
                if (careData.sumber) {
                  html += `<div class="recommendation-source">Sumber: ${careData.sumber}</div>`;
                }

                // Add download button
                html += `<div class="download-section">
                          <button id="download-pdf" class="download-btn">
                            <i class="fas fa-file-pdf"></i> Unduh PDF
                          </button>
                        </div>`;

                html += '</div>';
                return html;
              }
              // Handle old format for backward compatibility
              else {
                let html = '<div class="pet-care-recommendations">';

                // Format each section from old format
                if (careData.jadwalMakan || careData["Jadwal makan"]) {
                  const mealSchedule = careData.jadwalMakan || careData["Jadwal makan"];
                  html += `<div class="section-title">Jadwal Makan:</div>
                          <div class="recommendation-item">${mealSchedule}</div>`;
                }

                if (careData.jenismakanan || careData["Jenis makanan yang direkomendasikan"]) {
                  const foodType = careData.jenismakanan || careData["Jenis makanan yang direkomendasikan"];
                  html += `<div class="section-title">Jenis Makanan:</div>
                          <div class="recommendation-item">${foodType}</div>`;
                }

                if (careData.kebutuhanOlahraga || careData["Kebutuhan olahraga/aktivitas"]) {
                  const exercise = careData.kebutuhanOlahraga || careData["Kebutuhan olahraga/aktivitas"];
                  html += `<div class="section-title">Kebutuhan Olahraga:</div>
                          <div class="recommendation-item">${exercise}</div>`;
                }

                if (careData.perawatanKesehatan || careData["Perawatan kesehatan rutin"]) {
                  const healthcare = careData.perawatanKesehatan || careData["Perawatan kesehatan rutin"];
                  html += `<div class="section-title">Perawatan Kesehatan:</div>
                          <div class="recommendation-item">${healthcare}</div>`;
                }

                if (careData.perawatanKebersihan || careData["Perawatan kebersihan"]) {
                  const hygiene = careData.perawatanKebersihan || careData["Perawatan kebersihan"];
                  html += `<div class="section-title">Perawatan Kebersihan:</div>
                          <div class="recommendation-item">${hygiene}</div>`;
                }

                if (careData.kebutuhanLingkungan || careData["Kebutuhan lingkungan"]) {
                  const environment = careData.kebutuhanLingkungan || careData["Kebutuhan lingkungan"];
                  html += `<div class="section-title">Kebutuhan Lingkungan:</div>
                          <div class="recommendation-item">${environment}</div>`;
                }

                if (careData.sosialDanPelatihan || careData["Sosial dan pelatihan"]) {
                  const socialTraining = careData.sosialDanPelatihan || careData["Sosial dan pelatihan"];
                  html += `<div class="section-title">Sosial dan Pelatihan:</div>
                          <div class="recommendation-item">${socialTraining}</div>`;
                }

                if (careData.tandaKesehatanBuruk || careData["Tanda-tanda masalah kesehatan"]) {
                  const healthIssues = careData.tandaKesehatanBuruk || careData["Tanda-tanda masalah kesehatan"];
                  html += `<div class="section-title">Tanda Masalah Kesehatan:</div>
                          <div class="recommendation-item">${healthIssues}</div>`;
                }

                html += '</div>';
                return html;
              }
            } catch (e) {
              console.error("Error formatting recommendations:", e);
              // If parsing fails, just return the text or error message
              if (typeof recommendations === 'string' && recommendations.startsWith('Error')) {
                return `<div class="error-message">
                        <p>Error saat memformat rekomendasi: ${e.message}</p>
                        <p>Silakan coba lagi nanti.</p>
                      </div>`;
              } else {
                return `<p>${recommendations}</p>`;
              }
            }
          }

          /**
           * Reset the application state
           */
          function resetApp() {
            // Reset form
            uploadForm.reset();

            // Reset preview
            previewContainer.innerHTML = '';
            iconImage.style.display = 'block';

            // Reset chat
            initialContent.style.display = 'block';
            chatContainer.style.display = 'none';
            chatContainer.innerHTML = '';

            // Reset button
            identifyButton.disabled = true;

            // Show confirmation toast
            showToast('Aplikasi telah direset', 'info');
          }

          /**
           * Process the pet identification
           * @param {Event} e - The event object
           */
          function processPetIdentification(e) {
            e.preventDefault();

            // Show chat interface
            initialContent.style.display = 'none';
            chatContainer.style.display = 'block';
            chatContainer.innerHTML = '';
            chatContainer.setAttribute('role', 'list');
            chatContainer.setAttribute('aria-label', 'Chat messages');

            // Add user message with the uploaded image
            let imgSrc = '';
            if (previewContainer.querySelector('img')) {
              imgSrc = previewContainer.querySelector('img').src;
            }

            const userMessageContent = `
              <p>Tolong identifikasi hewan peliharaan ini:</p>
              <img src="${imgSrc}" style="max-width: 100%; max-height: 200px; margin-top: 10px; border-radius: 8px;" alt="Gambar hewan peliharaan">`;
            addMessage(userMessageContent);
            showLoading();

            // Send to server
            const formData = new FormData(uploadForm);

            fetch('/predict', {
              method: "POST",
              body: formData
            })
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              hideLoading();
                // Simpan data untuk digunakan oleh PDF generator
                lastPetData = data;
              // Format the first response with basic identification
              const identificationContent = `
                <div class="pet-info-section">
                  <div class="pet-info-header">
                    <strong>Identifikasi Hewan:</strong>
                    <span class="confidence-badge">${data.confidence}% Keyakinan</span>
                  </div>
                  <p>Hewan peliharaan Anda adalah <strong>${data.predicted_breed}</strong></p>
                  <p><em>Terdeteksi menggunakan model ${data.model_used}</em></p>
                </div>
                <div class="pet-info-section">
                  <strong>Informasi:</strong>
                  <p>${data.breed_info}</p>
                </div>
              `;

              addMessage(identificationContent, true);

              // After a short delay, show care recommendations
              setTimeout(() => {
                const careContent = `
                  <div class="pet-care-header">
                    <strong>Rekomendasi Perawatan untuk ${data.predicted_breed}:</strong>
                    ${data.recommendations_source ?
                      `<span class="recommendation-source-badge">Sumber: ${data.recommendations_source}</span>` : ''}
                  </div>
                  ${formatCareRecommendations(data.care_recommendations)}
                `;

                addMessage(careContent, true);

                // Tunggu sebentar agar DOM diperbarui
                setTimeout(() => {
                // Pasang event listener untuk tombol download
                setupPDFDownload(data);
                }, 200);

                // Add options for more interaction
                setTimeout(() => {
                    const followupContent = `
                        <p>Anda telah mendapatkan informasi dasar tentang ${data.predicted_breed}. Untuk mendapatkan panduan perawatan yang lebih terperinci, silakan konsultasikan dengan dokter hewan terdekat.</p>
                        <p>Untuk menyimpan informasi ini, gunakan tombol "Unduh PDF" di atas.</p>
                    `;

                    addMessage(followupContent, true);
                    }, 1500);
              }, 1000);
            })
            .catch(error => {
              hideLoading();
              console.error("Error:", error);

              // Provide more specific error messages
              let errorMessage = 'Terjadi kesalahan saat menghubungi server.';

              if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                errorMessage = 'Gagal terhubung ke server. Periksa koneksi internet Anda.';
              } else if (error.message.includes('timeout')) {
                errorMessage = 'Server terlalu lama merespons. Silakan coba lagi.';
              } else if (error.message.includes('404')) {
                errorMessage = 'Endpoint API tidak ditemukan. Silakan hubungi administrator.';
              } else if (error.message.includes('500')) {
                errorMessage = 'Terjadi kesalahan pada server. Silakan coba lagi nanti.';
              }

              addMessage(`
                <p>Maaf, ${errorMessage}</p>
                <p>Detail error: ${error.message}</p>
                <button class="retry-btn" style="background-color: #3b82f6; color: white; border: none; padding: 8px 12px; border-radius: 4px; margin-top: 10px; cursor: pointer;"
                  onclick="document.getElementById('identify-button').click()">Coba Lagi</button>
              `, true);

              showToast('Terjadi kesalahan', 'error');
            });
          }

          // Initialize accessibility attributes
          function initAccessibility() {
            uploadImageDropzone.setAttribute('role', 'button');
            uploadImageDropzone.setAttribute('tabindex', '0');
            uploadImageDropzone.setAttribute('aria-label', 'Drop area untuk unggah gambar');

            identifyButton.setAttribute('aria-label', 'Identifikasi Hewan Peliharaan');
            resetButton.setAttribute('aria-label', 'Reset Aplikasi');

            chatContainer.setAttribute('role', 'log');
            chatContainer.setAttribute('aria-live', 'polite');
          }

          // Add event listeners
          function initEventListeners() {
            // File input change event
            imageUpload.addEventListener('change', function() {
              handleImageUpload(this);
            });

            // Click on dropzone should trigger file input
            uploadImageDropzone.addEventListener('click', function(e) {
              // Don't trigger when clicking on the preview image or label
              if (e.target !== imageUpload && e.target !== buttonSubmit) {
                imageUpload.click();
              }
            });

            // Make the entire dropzone clickable for keyboard users
            uploadImageDropzone.addEventListener('keydown', function(e) {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                imageUpload.click();
              }
            });

            // Drag and drop events
            uploadImageDropzone.addEventListener('dragover', function(e) {
              e.preventDefault();
              this.style.borderColor = '#10b981';
              this.style.backgroundColor = '#f0fdfa';
            });

            uploadImageDropzone.addEventListener('dragleave', function() {
              this.style.borderColor = '#d1d5db';
              this.style.backgroundColor = '#ffffff';
            });

            uploadImageDropzone.addEventListener('drop', function(e) {
              e.preventDefault();
              this.style.borderColor = '#d1d5db';
              this.style.backgroundColor = '#ffffff';

              const files = e.dataTransfer.files;
              if (files.length > 0) {
                imageUpload.files = files;
                handleImageUpload(imageUpload);
              }
            });

            // Identify button click
            identifyButton.addEventListener('click', processPetIdentification);

            // Reset button click with confirmation
            resetButton.addEventListener('click', function() {
              if (previewContainer.innerHTML !== '') {
                if (confirm('Apakah Anda yakin ingin mereset? Ini akan menghapus analisis hewan peliharaan saat ini.')) {
                  resetApp();
                }
              } else {
                resetApp();
              }
            });

            // Form submission
            uploadForm.addEventListener('submit', function(e) {
              e.preventDefault();
              if (!identifyButton.disabled) {
                identifyButton.click();
              }
            });
          }

          // Initialize everything
          initAccessibility();
          initEventListeners();

          // Expose necessary functions to window for button onclick handlers in HTML
          window.showToast = showToast;
        });
        </script>
  </body>
</html>
